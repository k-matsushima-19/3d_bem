module solution_helmholtz_class
  use misc
  use math
  use mesh3d_class
  implicit none
  private

  type,public :: solution_helmholtz
     !> 境界メッシュ
     type(mesh3d),pointer :: mesh => null()
     !> 境界上の解 (:,1): u, (:,2): q
     complex(8),allocatable :: u_bndry(:,:)
   contains
     !> 初期化
     procedure :: init
     !> 境界の解を出力
     procedure :: output_bndry
     !> 境界の解をファイルに出力 (geomviewで表示用)
     procedure :: output_bndry_geomview
  end type solution_helmholtz

  integer,parameter :: cmap(3,256) = reshape(&
       [ &
       0.00000, 0.00000, 0.51562, &
       0.00000, 0.00000, 0.53125, &
       0.00000, 0.00000, 0.54688, &
       0.00000, 0.00000, 0.56250, &
       0.00000, 0.00000, 0.57812, &
       0.00000, 0.00000, 0.59375, &
       0.00000, 0.00000, 0.60938, &
       0.00000, 0.00000, 0.62500, &
       0.00000, 0.00000, 0.64062, &
       0.00000, 0.00000, 0.65625, &
       0.00000, 0.00000, 0.67188, &
       0.00000, 0.00000, 0.68750, &
       0.00000, 0.00000, 0.70312, &
       0.00000, 0.00000, 0.71875, &
       0.00000, 0.00000, 0.73438, &
       0.00000, 0.00000, 0.75000, &
       0.00000, 0.00000, 0.76562, &
       0.00000, 0.00000, 0.78125, &
       0.00000, 0.00000, 0.79688, &
       0.00000, 0.00000, 0.81250, &
       0.00000, 0.00000, 0.82812, &
       0.00000, 0.00000, 0.84375, &
       0.00000, 0.00000, 0.85938, &
       0.00000, 0.00000, 0.87500, &
       0.00000, 0.00000, 0.89062, &
       0.00000, 0.00000, 0.90625, &
       0.00000, 0.00000, 0.92188, &
       0.00000, 0.00000, 0.93750, &
       0.00000, 0.00000, 0.95312, &
       0.00000, 0.00000, 0.96875, &
       0.00000, 0.00000, 0.98438, &
       0.00000, 0.00000, 1.00000, &
       0.00000, 0.01562, 1.00000, &
       0.00000, 0.03125, 1.00000, &
       0.00000, 0.04688, 1.00000, &
       0.00000, 0.06250, 1.00000, &
       0.00000, 0.07812, 1.00000, &
       0.00000, 0.09375, 1.00000, &
       0.00000, 0.10938, 1.00000, &
       0.00000, 0.12500, 1.00000, &
       0.00000, 0.14062, 1.00000, &
       0.00000, 0.15625, 1.00000, &
       0.00000, 0.17188, 1.00000, &
       0.00000, 0.18750, 1.00000, &
       0.00000, 0.20312, 1.00000, &
       0.00000, 0.21875, 1.00000, &
       0.00000, 0.23438, 1.00000, &
       0.00000, 0.25000, 1.00000, &
       0.00000, 0.26562, 1.00000, &
       0.00000, 0.28125, 1.00000, &
       0.00000, 0.29688, 1.00000, &
       0.00000, 0.31250, 1.00000, &
       0.00000, 0.32812, 1.00000, &
       0.00000, 0.34375, 1.00000, &
       0.00000, 0.35938, 1.00000, &
       0.00000, 0.37500, 1.00000, &
       0.00000, 0.39062, 1.00000, &
       0.00000, 0.40625, 1.00000, &
       0.00000, 0.42188, 1.00000, &
       0.00000, 0.43750, 1.00000, &
       0.00000, 0.45312, 1.00000, &
       0.00000, 0.46875, 1.00000, &
       0.00000, 0.48438, 1.00000, &
       0.00000, 0.50000, 1.00000, &
       0.00000, 0.51562, 1.00000, &
       0.00000, 0.53125, 1.00000, &
       0.00000, 0.54688, 1.00000, &
       0.00000, 0.56250, 1.00000, &
       0.00000, 0.57812, 1.00000, &
       0.00000, 0.59375, 1.00000, &
       0.00000, 0.60938, 1.00000, &
       0.00000, 0.62500, 1.00000, &
       0.00000, 0.64062, 1.00000, &
       0.00000, 0.65625, 1.00000, &
       0.00000, 0.67188, 1.00000, &
       0.00000, 0.68750, 1.00000, &
       0.00000, 0.70312, 1.00000, &
       0.00000, 0.71875, 1.00000, &
       0.00000, 0.73438, 1.00000, &
       0.00000, 0.75000, 1.00000, &
       0.00000, 0.76562, 1.00000, &
       0.00000, 0.78125, 1.00000, &
       0.00000, 0.79688, 1.00000, &
       0.00000, 0.81250, 1.00000, &
       0.00000, 0.82812, 1.00000, &
       0.00000, 0.84375, 1.00000, &
       0.00000, 0.85938, 1.00000, &
       0.00000, 0.87500, 1.00000, &
       0.00000, 0.89062, 1.00000, &
       0.00000, 0.90625, 1.00000, &
       0.00000, 0.92188, 1.00000, &
       0.00000, 0.93750, 1.00000, &
       0.00000, 0.95312, 1.00000, &
       0.00000, 0.96875, 1.00000, &
       0.00000, 0.98438, 1.00000, &
       0.00000, 1.00000, 1.00000, &
       0.01562, 1.00000, 0.98438, &
       0.03125, 1.00000, 0.96875, &
       0.04688, 1.00000, 0.95312, &
       0.06250, 1.00000, 0.93750, &
       0.07812, 1.00000, 0.92188, &
       0.09375, 1.00000, 0.90625, &
       0.10938, 1.00000, 0.89062, &
       0.12500, 1.00000, 0.87500, &
       0.14062, 1.00000, 0.85938, &
       0.15625, 1.00000, 0.84375, &
       0.17188, 1.00000, 0.82812, &
       0.18750, 1.00000, 0.81250, &
       0.20312, 1.00000, 0.79688, &
       0.21875, 1.00000, 0.78125, &
       0.23438, 1.00000, 0.76562, &
       0.25000, 1.00000, 0.75000, &
       0.26562, 1.00000, 0.73438, &
       0.28125, 1.00000, 0.71875, &
       0.29688, 1.00000, 0.70312, &
       0.31250, 1.00000, 0.68750, &
       0.32812, 1.00000, 0.67188, &
       0.34375, 1.00000, 0.65625, &
       0.35938, 1.00000, 0.64062, &
       0.37500, 1.00000, 0.62500, &
       0.39062, 1.00000, 0.60938, &
       0.40625, 1.00000, 0.59375, &
       0.42188, 1.00000, 0.57812, &
       0.43750, 1.00000, 0.56250, &
       0.45312, 1.00000, 0.54688, &
       0.46875, 1.00000, 0.53125, &
       0.48438, 1.00000, 0.51562, &
       0.50000, 1.00000, 0.50000, &
       0.51562, 1.00000, 0.48438, &
       0.53125, 1.00000, 0.46875, &
       0.54688, 1.00000, 0.45312, &
       0.56250, 1.00000, 0.43750, &
       0.57812, 1.00000, 0.42188, &
       0.59375, 1.00000, 0.40625, &
       0.60938, 1.00000, 0.39062, &
       0.62500, 1.00000, 0.37500, &
       0.64062, 1.00000, 0.35938, &
       0.65625, 1.00000, 0.34375, &
       0.67188, 1.00000, 0.32812, &
       0.68750, 1.00000, 0.31250, &
       0.70312, 1.00000, 0.29688, &
       0.71875, 1.00000, 0.28125, &
       0.73438, 1.00000, 0.26562, &
       0.75000, 1.00000, 0.25000, &
       0.76562, 1.00000, 0.23438, &
       0.78125, 1.00000, 0.21875, &
       0.79688, 1.00000, 0.20312, &
       0.81250, 1.00000, 0.18750, &
       0.82812, 1.00000, 0.17188, &
       0.84375, 1.00000, 0.15625, &
       0.85938, 1.00000, 0.14062, &
       0.87500, 1.00000, 0.12500, &
       0.89062, 1.00000, 0.10938, &
       0.90625, 1.00000, 0.09375, &
       0.92188, 1.00000, 0.07812, &
       0.93750, 1.00000, 0.06250, &
       0.95312, 1.00000, 0.04688, &
       0.96875, 1.00000, 0.03125, &
       0.98438, 1.00000, 0.01562, &
       1.00000, 1.00000, 0.00000, &
       1.00000, 0.98438, 0.00000, &
       1.00000, 0.96875, 0.00000, &
       1.00000, 0.95312, 0.00000, &
       1.00000, 0.93750, 0.00000, &
       1.00000, 0.92188, 0.00000, &
       1.00000, 0.90625, 0.00000, &
       1.00000, 0.89062, 0.00000, &
       1.00000, 0.87500, 0.00000, &
       1.00000, 0.85938, 0.00000, &
       1.00000, 0.84375, 0.00000, &
       1.00000, 0.82812, 0.00000, &
       1.00000, 0.81250, 0.00000, &
       1.00000, 0.79688, 0.00000, &
       1.00000, 0.78125, 0.00000, &
       1.00000, 0.76562, 0.00000, &
       1.00000, 0.75000, 0.00000, &
       1.00000, 0.73438, 0.00000, &
       1.00000, 0.71875, 0.00000, &
       1.00000, 0.70312, 0.00000, &
       1.00000, 0.68750, 0.00000, &
       1.00000, 0.67188, 0.00000, &
       1.00000, 0.65625, 0.00000, &
       1.00000, 0.64062, 0.00000, &
       1.00000, 0.62500, 0.00000, &
       1.00000, 0.60938, 0.00000, &
       1.00000, 0.59375, 0.00000, &
       1.00000, 0.57812, 0.00000, &
       1.00000, 0.56250, 0.00000, &
       1.00000, 0.54688, 0.00000, &
       1.00000, 0.53125, 0.00000, &
       1.00000, 0.51562, 0.00000, &
       1.00000, 0.50000, 0.00000, &
       1.00000, 0.48438, 0.00000, &
       1.00000, 0.46875, 0.00000, &
       1.00000, 0.45312, 0.00000, &
       1.00000, 0.43750, 0.00000, &
       1.00000, 0.42188, 0.00000, &
       1.00000, 0.40625, 0.00000, &
       1.00000, 0.39062, 0.00000, &
       1.00000, 0.37500, 0.00000, &
       1.00000, 0.35938, 0.00000, &
       1.00000, 0.34375, 0.00000, &
       1.00000, 0.32812, 0.00000, &
       1.00000, 0.31250, 0.00000, &
       1.00000, 0.29688, 0.00000, &
       1.00000, 0.28125, 0.00000, &
       1.00000, 0.26562, 0.00000, &
       1.00000, 0.25000, 0.00000, &
       1.00000, 0.23438, 0.00000, &
       1.00000, 0.21875, 0.00000, &
       1.00000, 0.20312, 0.00000, &
       1.00000, 0.18750, 0.00000, &
       1.00000, 0.17188, 0.00000, &
       1.00000, 0.15625, 0.00000, &
       1.00000, 0.14062, 0.00000, &
       1.00000, 0.12500, 0.00000, &
       1.00000, 0.10938, 0.00000, &
       1.00000, 0.09375, 0.00000, &
       1.00000, 0.07812, 0.00000, &
       1.00000, 0.06250, 0.00000, &
       1.00000, 0.04688, 0.00000, &
       1.00000, 0.03125, 0.00000, &
       1.00000, 0.01562, 0.00000, &
       1.00000, 0.00000, 0.00000, &
       0.98438, 0.00000, 0.00000, &
       0.96875, 0.00000, 0.00000, &
       0.95312, 0.00000, 0.00000, &
       0.93750, 0.00000, 0.00000, &
       0.92188, 0.00000, 0.00000, &
       0.90625, 0.00000, 0.00000, &
       0.89062, 0.00000, 0.00000, &
       0.87500, 0.00000, 0.00000, &
       0.85938, 0.00000, 0.00000, &
       0.84375, 0.00000, 0.00000, &
       0.82812, 0.00000, 0.00000, &
       0.81250, 0.00000, 0.00000, &
       0.79688, 0.00000, 0.00000, &
       0.78125, 0.00000, 0.00000, &
       0.76562, 0.00000, 0.00000, &
       0.75000, 0.00000, 0.00000, &
       0.73438, 0.00000, 0.00000, &
       0.71875, 0.00000, 0.00000, &
       0.70312, 0.00000, 0.00000, &
       0.68750, 0.00000, 0.00000, &
       0.67188, 0.00000, 0.00000, &
       0.65625, 0.00000, 0.00000, &
       0.64062, 0.00000, 0.00000, &
       0.62500, 0.00000, 0.00000, &
       0.60938, 0.00000, 0.00000, &
       0.59375, 0.00000, 0.00000, &
       0.57812, 0.00000, 0.00000, &
       0.56250, 0.00000, 0.00000, &
       0.54688, 0.00000, 0.00000, &
       0.53125, 0.00000, 0.00000, &
       0.51562, 0.00000, 0.00000, &
       0.50000, 0.00000, 0.00000 &
       ]*255, [3,256])
  
contains
  !> 初期化
  !! \param self
  !! \param mesh 境界メッシュ
  subroutine init(self, mesh)
    class(solution_helmholtz),intent(out) :: self
    type(mesh3d),intent(inout),target :: mesh

    self%mesh => mesh

    allocate(self%u_bndry(self%mesh%ne,2))
    self%u_bndry(:,:) = zero
  end subroutine init

  !> 境界の解をファイルに出力
  !! \param self
  !! \param filename ファイル名
  subroutine output_bndry(self, filename)
    class(solution_helmholtz),intent(in) :: self
    character(*),intent(in) :: filename

    integer :: i

    open(10,file=filename)
    do i=1,self%mesh%ne
       write(10,'(7e24.16)') self%mesh%c(1:3,i), real(self%u_bndry(i,1)), aimag(self%u_bndry(i,1)), &
            real(self%u_bndry(i,2)), aimag(self%u_bndry(i,2))
    end do
    close(10)
    
  end subroutine output_bndry

  !> 境界の解をファイルに出力 (geomviewで表示用)
  !! \param self
  !! \param filename ファイル名
  subroutine output_bndry_geomview(self, filename)
    class(solution_helmholtz),intent(in) :: self
    character(*),intent(in) :: filename

    real(8) :: maxu, minu, tmp
    integer :: i

    open(10,file=filename)
    write(10,'(A)') "OFF"
    write(10,'(3i7)') self%mesh%np, self%mesh%ne, 0
    do i=1,self%mesh%np
       ! write(10,'(3f10.6)') self%mesh%p(1,i),self%mesh%p(2,i),self%mesh%p(3,i)
       write(10,'(3e24.16)') self%mesh%p(1,i),self%mesh%p(2,i),self%mesh%p(3,i)
    end do
    
    maxu=maxval(real(self%u_bndry(:,1)))
    minu=minval(real(self%u_bndry(:,1)))

    write(*,*) minu, maxu
    
    do i=1,self%mesh%ne       
       tmp=(real(self%u_bndry(i,1))-minu)*255.d0/(maxu-minu)+1.d0
       
       
       write(10,'(i2,3i7,4i4)') 3,self%mesh%nd(1,i)-1,self%mesh%nd(3,i)-1,self%mesh%nd(2,i)-1,&
       	cmap(1,int(tmp)),cmap(2,int(tmp)),cmap(3,int(tmp)),255
       ! write(2,*) int(tmp)
    end do
    close(10)
    
  end subroutine output_bndry_geomview
end module solution_helmholtz_class
